<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STAGING3 Meal Coach CHAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#ffffff; color:#222; display:flex; flex-direction:column; height:100vh; }
    header { padding:12px 16px; background:#ffffff; border-bottom:1px solid #e6e6e6; font-weight:700; text-align:center; }
    #topbar { display:flex; gap:8px; align-items:center; justify-content:center; padding:8px 12px; background:#fff; border-bottom:1px solid #eee; }
    #modelUsed { font-size:12px; color:#666; }
    #chat { flex:1; overflow:auto; padding:16px; background:#fafafa; display:flex; flex-direction:column; gap:10px; }
    .msg { position:relative; padding:10px 14px; border-radius:14px; max-width: 800px; line-height:1.5; }
    .user { align-self:flex-end; background:#e6f4ff; color:#1a1a1a; }
    .ai { align-self:flex-start; background:#f1f1f1; color:#1a1a1a; }
    /* message text container (so copy button doesn't get copied) */
    .msg .content { white-space:pre-wrap; padding-right:56px; }

    #composerWrap { background:#fff; border-top:1px solid #e6e6e6; padding:12px; }
    #composer { display:flex; gap:8px; max-width: 980px; margin:0 auto; }
    textarea { flex:1; resize:none; padding:12px; border-radius:12px; border:1px solid #ccc; background:#fff; color:#222; min-height:56px; }
    button { padding:12px 16px; border:none; border-radius:10px; background:#10a37f; color:#fff; font-weight:600; cursor:pointer; }
    button:hover { background:#0d876a; }
    #actions { display:flex; gap:8px; align-items:center; justify-content:center; padding:8px 12px; background:#fff; border-top:1px solid #eee; flex-wrap:wrap; }
    .linkish { background:#eef7f3; color:#0d876a; border:1px solid #cfe7dd; }
    .linkish:hover { background:#dff2ea; }

    /* per-bubble copy button */
    .copyBtn {
      position:absolute; top:6px; right:8px;
      font-size:12px; padding:4px 8px; border-radius:8px;
      background:#eef7f3; color:#0d876a; border:1px solid #cfe7dd; cursor:pointer;
    }
    .copyBtn:hover { background:#dff2ea; }

    @media (max-width: 640px) {
      #composer { flex-direction:column; }
      button { width:100%; }
      #actions { flex-direction:column; }
    }

    /* thinking: animated . .. ... indicator */
    .thinking {
      display:none;
      opacity:.75;
      margin:6px 16px;
      font-size:14px;
      align-self:flex-start;
      color:#444;
    }
    .thinking::after {
      content:"...";
      animation:dots 1s steps(3,end) infinite;
    }
    @keyframes dots { 0%{content:"."} 33%{content:".."} 66%{content:"..."} 100%{content:""} }
  </style>
</head>
<body>
  <header>STAGING Meal Plan Coach Chat</header>

  <div id="topbar">
    <span id="modelUsed">(actual model: checking…)</span>
  </div>

  <div id="chat"></div>

  <!-- thinking: lives under the chat, shows while waiting -->
  <div id="thinking" class="thinking" aria-live="polite">Thinking</div>

  <div id="composerWrap">
    <form id="composer">
      <textarea id="input" placeholder="Tell me your calories & macro targets, foods you like/avoid, cooking time, budget, and meals/day…"></textarea>
      <button id="send" type="submit">Send</button>
    </form>
  </div>

  <div id="actions">
    <button id="reset" class="linkish" type="button">Clear Chat</button>
  </div>

  <script>
    const chatEl   = document.getElementById('chat');
    const form     = document.getElementById('composer');
    const input    = document.getElementById('input');
    const sendBtn  = document.getElementById('send');
    const resetBtn = document.getElementById('reset');
    const modelUsedEl = document.getElementById('modelUsed');
    const thinkingEl  = document.getElementById('thinking'); // thinking

    // Load or seed chat history
    let messages = [];
    try {
      messages = JSON.parse(localStorage.getItem('fam_msgs') || '[]');
    } catch { messages = []; }

    if (messages.length === 0) {
      messages.push({
        role: 'assistant',
        content:
`Hi! I’m your meal plan coach. Tell me:
• Calories & macro targets (protein/carbs/fat)
• Foods you like/avoid
• Cooking time & budget
• Number of meals/day

I’ll build and fine-tune a meal plan you can actually follow.`
      });
    }
    renderAll();

    resetBtn.onclick = () => {
      messages = [{
        role: 'assistant',
        content:
`Hi! I’m your meal plan coach. Tell me:
• Calories & macro targets (protein/carbs/fat)
• Foods you like/avoid
• Cooking time & budget
• Number of meals/day

I’ll build and fine-tune a meal plan you can actually follow.`
      }];
      persist();
      renderAll();
      modelUsedEl.textContent = '(actual model: checking…)';
    };

    // ---------- Safe copy utilities (Clipboard API + fallback) ----------
    function fallbackCopy(text) {
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      } catch (e) {
        console.warn('Fallback copy failed', e);
      }
    }
    async function safeCopy(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          fallbackCopy(text);
        }
        return true;
      } catch (e) {
        console.warn('Clipboard API failed', e);
        try { fallbackCopy(text); return true; } catch { return false; }
      }
    }
    function flashButton(btn, ok=true) {
      if (!btn) return;
      const orig = btn.textContent;
      btn.disabled = true;
      btn.textContent = ok ? 'Copied!' : 'Copy failed';
      setTimeout(() => { btn.disabled = false; btn.textContent = orig; }, 1200);
    }

    // Generic copy handler that reads data-copy or data-copy-text
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-copy], [data-copy-text]');
      if (!btn) return;
      try {
        let text = '';
        const sel = btn.getAttribute('data-copy');
        if (sel) {
          const el = document.querySelector(sel);
          if (el) text = (el.value ?? el.textContent ?? '').trim();
        } else {
          text = (btn.getAttribute('data-copy-text') || '').trim();
        }
        const ok = text ? await safeCopy(text) : false;
        flashButton(btn, ok);
      } catch (err) {
        console.warn('Copy handler error', err);
        flashButton(btn, false);
      }
    });

    // ---------- Chat submit logic ----------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      // Add user message locally
      messages.push({ role: 'user', content: text });
      persist();
      appendMessage('user', text);
      input.value = '';

      // thinking: show indicator and disable inputs
      showThinking(true);
      disableComposer(true);

      // Call your API with the CORRECT shape: { messages, model }
      let resp;
      try {
        resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, model: 'gpt-4o' }) // locked to 4o
        });
      } catch {
        appendMessage('assistant', 'Sorry — network error. Try again.');
        messages.push({ role: 'assistant', content: 'Sorry — network error. Try again.' });
        persist();
        showThinking(false);
        disableComposer(false);
        return;
      }

      if (!resp.ok) {
        let errText = 'Sorry — the server returned an error.';
        try {
          const j = await resp.json();
          if (j?.error) errText = `Sorry — ${j.error}`;
        } catch {}
        appendMessage('assistant', errText);
        messages.push({ role: 'assistant', content: errText });
        persist();
        showThinking(false);
        disableComposer(false);
        return;
      }

      const data = await resp.json();
      if (data?.model_used) {
        modelUsedEl.textContent = `(actual model: ${data.model_used})`;
      }

      const reply = data?.reply || '…';
      appendMessage('assistant', reply);
      messages.push({ role: 'assistant', content: reply });
      persist();

      showThinking(false);
      disableComposer(false);
    });

    // ---------- Rendering helpers ----------
    let msgId = 0; // unique IDs for bubbles so copy buttons can target text only

    function appendMessage(role, text) {
      const id = `m${++msgId}`;

      const bubble = document.createElement('div');
      bubble.className = `msg ${role === 'user' ? 'user' : 'ai'}`;
      bubble.id = id;

      const content = document.createElement('div');
      content.className = 'content';
      content.id = `${id}-content`;
      content.textContent = text;
      bubble.appendChild(content);

      // Per-bubble copy button (works for both AI and User)
      const btn = document.createElement('button');
      btn.className = 'copyBtn';
      btn.type = 'button';
      btn.setAttribute('aria-label', 'Copy message');
      btn.setAttribute('data-copy', `#${id}-content`); // copy only the text div
      btn.textContent = 'Copy';
      bubble.appendChild(btn);

      chatEl.appendChild(bubble);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function renderAll() {
      chatEl.innerHTML = '';
      msgId = 0; // reset so IDs are consistent on render
      for (const m of messages) appendMessage(m.role, m.content);
    }

    function persist() {
      localStorage.setItem('fam_msgs', JSON.stringify(messages));
    }

    // thinking: tiny helpers
    function showThinking(show) {
      if (!thinkingEl) return;
      thinkingEl.style.display = show ? 'inline-block' : 'none';
      if (show) thinkingEl.scrollIntoView({ block: 'end' });
    }
    function disableComposer(disabled) {
      input.disabled = disabled;
      sendBtn.disabled = disabled;
    }

    // Send on Enter (Shift+Enter = newline)
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });
  </script>
</body>
</html>