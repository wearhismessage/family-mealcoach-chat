<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Meal Plan Hero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Google Fonts: Roboto (fallback to Arial/system if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Detect if running inside an iframe -->
  <script>
    (function () {
      try {
        if (window.top !== window.self) {
          document.documentElement.classList.add('embedded');
        }
      } catch (_) {
        document.documentElement.classList.add('embedded');
      }
    })();
  </script>

  <style>
    /* --- Global font (Roboto with fallbacks) --- */
    :root {
      --app-font: "Roboto", Arial, "Segoe UI", system-ui, -apple-system, "Noto Sans", sans-serif;
      --emoji-fonts: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji";
    }

    /* --- global/mobile guards --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0; background:#fff; color:#222; display:flex; flex-direction:column; min-height:100dvh; overflow-x:hidden;
      font-family: var(--app-font), var(--emoji-fonts);   /* << font applied */
    }

    /* Ensure controls inherit font */
    button, input, select, textarea { font: inherit; }

    /* Header (hidden when embedded) */
    header {
      padding:8px 10px;            /* tighter */
      background:#fff;
      border-bottom:1px solid #e6e6e6;
      font-weight:700;
      text-align:center;
      line-height:1.2;
    }
    .embedded header { display:none; }

    /* Chat area */
    #chat {
      flex:1;
      overflow:auto;
      padding:10px;
      background:#fafafa;
      display:flex;
      flex-direction:column;
      gap:8px;
      -webkit-overflow-scrolling: touch;
    }
    .msg { position:relative; padding:8px 12px; border-radius:14px; max-width:800px; line-height:1.5; }
    .user { align-self:flex-end; background:#e6f4ff; color:#1a1a1a; }
    .ai   { align-self:flex-start; background:#f1f1f1; color:#1a1a1a; }
    .msg .content { white-space:pre-wrap; padding-right:44px; padding-bottom:30px; }

    /* Composer (sticky + safe-area) */
    #composerWrap {
      position: sticky;
      bottom: 0;
      left: 0; right: 0;
      background:#fff;
      border-top:1px solid #e6e6e6;
      padding:8px 8px 12px;        /* extra bottom for safe-area */
      z-index: 5;
    }
    @supports (padding: max(0px)) {
      #composerWrap { padding-bottom: max(12px, env(safe-area-inset-bottom)); }
    }

    #composer {
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width:980px;
      margin:0 auto;
      width:100%;
      min-width:0;                 /* prevent overflow on small screens */
    }

    textarea {
      flex:1 1 auto;
      width:100%;
      min-width:0;                 /* critical for mobile flex overflow */
      resize:none;
      padding:10px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      color:#222;
      min-height:52px;
      margin:0;
    }

    /* Side-by-side actions */
    .actions {
      display:flex;
      gap:6px;
      margin:0;
      align-items:center;
      flex-wrap:nowrap;            /* keep on one line */
      min-width:0;
    }
    .actions button {
      flex:1 1 0;
      padding:10px 14px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space:nowrap;          /* avoid wrapping text that widens layout */
    }
    .actions .clear { background:#f0f5f0; color:#333; border:1px solid #cfe7dd; }
    .actions .clear:hover { background:#e8f2ec; }
    .actions .send { background:#10a37f; color:#fff; }
    .actions .send:hover { background:#0d876a; }

    /* Copy icon per bubble */
    .copyBtn {
      position:absolute; bottom:6px; right:6px;
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px; border-radius:8px; background:#eef7f3; color:#0d876a;
      border:1px solid #cfe7dd; cursor:pointer; line-height:0;
    }
    .copyBtn:hover { background:#dff2ea; }
    .copyBtn svg { width:16px; height:16px; }

    /* Thinking indicator */
    .thinking { display:none; opacity:.75; margin:6px 12px; font-size:14px; align-self:flex-start; color:#444; }
    .thinking::after { content:"..."; animation:dots 1s steps(3,end) infinite; }
    @keyframes dots { 0%{content:"."} 33%{content:".."} 66%{content:"..."} 100%{content:""} }

    /* a11y helper */
    .sr-only {
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Mobile tweaks */
    @media (max-width:640px){
      header { padding:6px 10px; font-size:18px; line-height:1.1; } /* smaller title bar */
      #chat { padding:8px; }
      .actions button { font-size:16px; }
    }

    /* Embedded (iframe) width fixes */
    .embedded #composer { max-width:none; width:100%; }           /* full width composer */
    .embedded #chat { padding-left:8px; padding-right:8px; }      /* tighter side padding */
  </style>
</head>
<body>

  <header>üçΩÔ∏è Meal Plan Hero</header>

  <div id="chat"></div>
  <div id="thinking" class="thinking" aria-live="polite">Thinking</div>

  <div id="composerWrap">
    <form id="composer">
      <textarea id="input" placeholder="Example: 2300 high-protein, egg whites for breakfast, no dairy."></textarea>
      <div class="actions">
        <button id="reset" class="clear" type="button">Clear Chat</button>
        <button id="send" class="send" type="submit">Send</button>
      </div>
    </form>
  </div>

  <!-- model info LAST -->
  <div style="padding:6px 8px; background:#fff; text-align:center;">
    <span id="modelUsed" style="font-size:12px; color:#666;">(actual model: checking‚Ä¶)</span>
  </div>

  <script>
    const chatEl   = document.getElementById('chat');
    const form     = document.getElementById('composer');
    const input    = document.getElementById('input');
    const sendBtn  = document.getElementById('send');
    const resetBtn = document.getElementById('reset');
    const modelUsedEl = document.getElementById('modelUsed');
    const thinkingEl  = document.getElementById('thinking');
    var msgId = 0;

    // New greeting (plain text)
    const GREETING = `üëã Hi! I‚Äôm your meal plan coach.
Just tell me:
‚Ä¢ Calories & goal (ex: 2300 high-protein)
‚Ä¢ Any foods you want (ex: egg whites, steak)
‚Ä¢ Any foods to avoid (ex: dairy, shrimp)

I‚Äôll build a plan around your preferences ‚Äî so include those upfront for the best results!
(Need recipes, tips, or quick swaps? Just ask anytime.)`;

    // Load or seed chat history
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('fam_msgs') || '[]'); } catch { messages = []; }
    if (messages.length === 0) {
      messages.push({ role: 'assistant', content: GREETING });
    }
    renderAll();

    resetBtn.onclick = () => {
      messages = [{ role: 'assistant', content: GREETING }];
      persist();
      renderAll();
      modelUsedEl.textContent = '(actual model: checking‚Ä¶)';
    };

    // Copy helpers
    function fallbackCopy(text) {
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.setAttribute('readonly','');
        ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
      } catch (e) { console.warn('Fallback copy failed', e); }
    }
    async function safeCopy(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else { fallbackCopy(text); }
        return true;
      } catch (e) { try { fallbackCopy(text); return true; } catch { return false; } }
    }
    function flashButton(btn, ok=true) {
      if (!btn) return;
      const orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = ok
        ? '<svg viewBox="0 0 16 16" aria-hidden="true"><path d="M6.5 10.5l-2-2 .7-.7 1.3 1.3 3-3 .7.7-3.7 3.7z"/></svg>'
        : '<svg viewBox="0 0 16 16" aria-hidden="true"><path d="M3 3l10 10M13 3L3 13"/></svg>';
      setTimeout(() => { btn.disabled = false; btn.innerHTML = orig; }, 900);
    }
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-copy], [data-copy-text]');
      if (!btn) return;
      try {
        let text = '';
        const sel = btn.getAttribute('data-copy');
        if (sel) {
          const el = document.querySelector(sel);
          if (el) text = (el.value ?? el.textContent ?? '').trim();
        } else {
          text = (btn.getAttribute('data-copy-text') || '').trim();
        }
        const ok = text ? await safeCopy(text) : false;
        flashButton(btn, ok);
      } catch { flashButton(e.target, false); }
    });

    // Chat submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      messages.push({ role: 'user', content: text });
      persist();
      appendMessage('user', text);
      input.value = '';

      showThinking(true);
      disableComposer(true);

      let resp;
      try {
        resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, model: 'gpt-4o' })
        });
      } catch {
        const msg = 'Sorry ‚Äî network error. Try again.';
        appendMessage('assistant', msg);
        messages.push({ role: 'assistant', content: msg });
        persist(); showThinking(false); disableComposer(false); return;
      }

      if (!resp.ok) {
        let errText = 'Sorry ‚Äî the server returned an error.';
        try { const j = await resp.json(); if (j?.error) errText = `Sorry ‚Äî ${j.error}`; } catch {}
        appendMessage('assistant', errText);
        messages.push({ role: 'assistant', content: errText });
        persist(); showThinking(false); disableComposer(false); return;
      }

      const data = await resp.json();
      if (data?.model_used) { modelUsedEl.textContent = `(actual model: ${data.model_used})`; }

      const reply = data?.reply || '‚Ä¶';
      appendMessage('assistant', reply);
      messages.push({ role: 'assistant', content: reply });
      persist();

      showThinking(false);
      disableComposer(false);
    });

    // Rendering
    function appendMessage(role, text) {
      const id = `m${++msgId}`;
      const bubble = document.createElement('div');
      bubble.className = `msg ${role === 'user' ? 'user' : 'ai'}`;
      bubble.id = id;

      const content = document.createElement('div');
      content.className = 'content';
      content.id = `${id}-content`;
      content.textContent = text;
      bubble.appendChild(content);

      const btn = document.createElement('button');
      btn.className = 'copyBtn';
      btn.type = 'button';
      btn.setAttribute('aria-label', 'Copy message');
      btn.setAttribute('title', 'Copy');
      btn.setAttribute('data-copy', `#${id}-content`);
      btn.innerHTML = '<svg viewBox="0 0 16 16" aria-hidden="true"><path d="M6 1h6a2 2 0 012 2v7h-2V3H6V1zm-2 4h6a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2zm0 2v7h6V7H4z"/></svg>';
      bubble.appendChild(btn);

      chatEl.appendChild(bubble);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function renderAll() { chatEl.innerHTML = ''; msgId = 0; for (const m of messages) appendMessage(m.role, m.content); }
    function persist() { localStorage.setItem('fam_msgs', JSON.stringify(messages)); }
    function showThinking(show) { if (!thinkingEl) return; thinkingEl.style.display = show ? 'inline-block' : 'none'; if (show) thinkingEl.scrollIntoView({ block:'end' }); }
    function disableComposer(disabled) { input.disabled = disabled; sendBtn.disabled = disabled; }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); form.requestSubmit(); }
    });
  </script>

  <!-- iframe auto-height helper -->
  <script>
    (function () {
      function postHeight() {
        const h = document.documentElement.scrollHeight || document.body.scrollHeight;
        window.parent?.postMessage({ type: "mpc-height", height: h }, "*");
      }
      window.addEventListener("load", postHeight);
      window.addEventListener("resize", postHeight);
      const ro = new ResizeObserver(postHeight);
      ro.observe(document.documentElement);
      const mo = new MutationObserver(postHeight);
      mo.observe(document.body, { childList: true, subtree: true, attributes: true, characterData: true });
    })();
  </script>

</body>
</html>
