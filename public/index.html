<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Family Meal Coach Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b1020; color:#e8ecf1; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { width:100%; padding:12px 14px; background:#0f1630; border-bottom:1px solid #1f2a4a; font-weight:700; text-align:center; }
    #controls { width:100%; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; padding:10px; background:#0f1630; border-bottom:1px solid #1f2a4a; }
    label { font-size:12px; opacity:0.9; }
    select, button { padding:8px 12px; border-radius:10px; border:1px solid #3952a3; background:#2340a0; color:#fff; font-weight:600; }
    #modelUsed { font-size:12px; color:#9fb0d9; }
    #chat { width:92%; max-width:720px; flex:1; margin-top:10px; background:#111836; border:1px solid #1f2a4a; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .msg { padding:12px 14px; border-radius:14px; max-width:85%; white-space:pre-wrap; line-height:1.45; }
    .user { align-self:flex-end; background:#2b335a; }
    .ai   { align-self:flex-start; background:#182042; }
    #composer { width:92%; max-width:720px; display:flex; gap:8px; padding:12px 0 20px; }
    textarea { flex:1; resize:none; padding:12px; border-radius:12px; border:1px solid #25325a; background:#0b1020; color:#e8ecf1; min-height:56px; }
    #send { min-width:90px; }
    .hint { color:#9fb0d9; font-size:12px; width:92%; max-width:720px; padding:6px 0 4px; }
  </style>
</head>
<body>
  <header>Family Meal Coach Chat</header>

  <div id="controls">
    <label for="model">Model:</label>
    <select id="model">
      <option value="gpt-4o" selected>gpt-4o (recommended)</option>
      <option value="gpt-4o-mini">gpt-4o-mini (cheaper)</option>
      <option value="gpt-5">gpt-5 (experimental)</option>
    </select>
    <button id="reset">Reset chat</button>
    <span id="modelUsed">(actual model: checking…)</span>
  </div>

  <div id="chat"></div>
  <div class="hint">Tip: Enter to send • Shift+Enter for a new line</div>

  <form id="composer">
    <textarea id="input" placeholder="Share calories & macro targets, foods you like/avoid, cooking time, budget, and meals/day..."></textarea>
    <button id="send" type="submit">Send</button>
  </form>

  <script>
    const chatEl   = document.getElementById('chat');
    const form     = document.getElementById('composer');
    const input    = document.getElementById('input');
    const modelSel = document.getElementById('model');
    const resetBtn = document.getElementById('reset');
    const modelUsedEl = document.getElementById('modelUsed');

    // Remember last chosen model; force default to 4o if it was 5 previously
    (function initModel(){
      const saved = localStorage.getItem('fam_model');
      if (!saved || saved === 'gpt-5') {
        modelSel.value = 'gpt-4o';
        localStorage.setItem('fam_model', 'gpt-4o');
      } else {
        modelSel.value = saved;
      }
    })();

    let messages = JSON.parse(localStorage.getItem('fam_msgs') || '[]');
    renderAll();

    modelSel.onchange = () => localStorage.setItem('fam_model', modelSel.value);

    resetBtn.onclick = () => {
      messages = [];
      localStorage.setItem('fam_msgs', JSON.stringify(messages));
      renderAll();
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      addMessage('user', text);
      input.value = '';

      // Call our API (non-streaming)
      let resp;
      try {
        resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, model: modelSel.value })
        });
      } catch {
        addMessage('assistant', 'Network error. Please try again.');
        return;
      }

      if (!resp.ok) {
        let msg = 'Sorry — the server returned an error.';
        try { const j = await resp.json(); if (j?.error) msg = `Sorry — ${j.error}`; } catch {}
        addMessage('assistant', msg);
        return;
      }

      const data = await resp.json();
      // Show the actual model we used this turn
      modelUsedEl.textContent = `(actual model: ${data?.model_used || 'unknown'})`;

      addMessage('assistant', data.reply || '…');
      localStorage.setItem('fam_msgs', JSON.stringify(messages));
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = `msg ${role === 'user' ? 'user' : 'ai'}`;
      div.textContent = content;
      chatEl.appendChild(div);
      messages.push({ role, content });
    }

    function renderAll() {
      chatEl.innerHTML = '';
      for (const m of messages) addMessage(m.role, m.content);
      if (messages.length === 0) {
        addMessage('assistant',
`Hi! I’m your nutrition coach. Tell me:
• Calories & macro targets (protein/carbs/fat)
• Foods you like/avoid
• Cooking time & budget
• Number of meals/day

I’ll build and fine-tune a plan you can actually follow.`);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
      localStorage.setItem('fam_msgs', JSON.stringify(messages));
    }

    // Enter to send, Shift+Enter newline
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });
  </script>
</body>
</html>
